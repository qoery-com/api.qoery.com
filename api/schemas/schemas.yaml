components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: integer
        message:
          type: string
          description: Additional error message
        details:
          type: string
          nullable: true
      required:
        - error
        - code

    EndpointUsageStats:
      type: object
      description: Usage statistics for a specific endpoint
      properties:
        calls_used:
          type: integer
          description: Number of calls used in current period
        calls_limit:
          type: string
          description: Maximum calls allowed in current period (returned as string)
        tokens_in:
          type: integer
          description: Total input tokens consumed in current period
        tokens_out:
          type: integer
          description: Total output tokens consumed in current period
        errors:
          type: integer
          description: Total number of errors in current period
        remaining:
          type: integer
          description: Number of calls remaining in current period
      required:
        - calls_used
        - calls_limit
        - tokens_in
        - tokens_out
        - errors
        - remaining

    UsageStats:
      type: object
      description: Usage statistics per endpoint
      properties:
        period_start:
          type: string
          format: date-time
          description: Start of the current usage period
        period_end:
          type: string
          format: date-time
          description: End of the current usage period
        plan:
          type: string
          description: Current subscription plan
        endpoints:
          type: object
          description: Usage statistics broken down by endpoint
          properties:
            nl:
              $ref: '#/components/schemas/EndpointUsageStats'
            sql:
              $ref: '#/components/schemas/EndpointUsageStats'
            scrape:
              $ref: '#/components/schemas/EndpointUsageStats'
          required:
            - nl
            - sql
            - scrape
      required:
        - period_start
        - period_end
        - plan
        - endpoints

    ObservationData:
      type: object
      description: A single observation with full metadata (flat structure)
      properties:
        ts:
          type: string
          format: date-time
          description: Timestamp of the observation
        value:
          type: string
          description: Value of the observation (returned as string)
        entity_name:
          type: string
          description: Human-readable name of the entity
        entity_id:
          type: string
          description: ID of the entity
          nullable: true
        metric_name:
          type: string
          description: Human-readable name of the metric
        metric_id:
          type: string
          description: ID of the metric
          nullable: true
        unit_name:
          type: string
          description: Human-readable name of the unit
        unit_id:
          type: string
          description: ID of the unit
          nullable: true
        frequency:
          type: string
          description: Frequency of the time series (e.g., monthly, annual)
          nullable: true
        series_description:
          type: string
          description: Description of the series
          nullable: true
        labels:
          type: object
          description: Additional labels and metadata
          additionalProperties: true
          nullable: true
        source:
          type: string
          description: Source URL for the data
          nullable: true
        series_id:
          type: string
          description: ID of the series
          nullable: true
      required:
        - ts
        - value

    # Removed deprecated QueryMetadata in favor of QueryMeta

    QueryResponse:
      type: object
      description: Response from query endpoints (both natural language and SQL)
      properties:
        sql_query:
          type: string
          description: The SQL query that was executed or generated
        series:
          type: array
          description: Array of series, each with its observations
          items:
            $ref: '#/components/schemas/Series'
        meta:
          $ref: '#/components/schemas/QueryMeta'
        description:
          type: string
          description: Natural language description of the query result
          nullable: true
      required:
        - sql_query
        - series
        - meta

    NLQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: Natural language query
      required:
        - query

    SQLQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: SQL query to execute
      required:
        - query

    Observation:
      type: object
      description: A single observation with typed value and structured attributes
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the observation
        value:
          oneOf:
            - type: number
            - type: string
            - type: boolean
          description: Value of the observation
        entity:
          $ref: '#/components/schemas/Entity'
        metric:
          $ref: '#/components/schemas/Metric'
        unit:
          $ref: '#/components/schemas/Unit'
        labels:
          type: object
          description: Additional labels and metadata
          additionalProperties: true
          nullable: true
      required:
        - timestamp
        - value

    Entity:
      type: object
      description: The entity that this observation refers to
      properties:
        id:
          type: string
          description: ID of the entity
        name:
          type: string
          description: Human-readable name of the entity
      required:
        - name

    Metric:
      type: object
      description: The metric that this observation measures
      properties:
        id:
          type: string
          description: ID of the metric
        name:
          type: string
          description: Human-readable name of the metric
      required:
        - name

    Unit:
      type: object
      description: The unit used for the observation value
      properties:
        id:
          type: string
          description: ID of the unit
        name:
          type: string
          description: Human-readable name of the unit
        symbol:
          type: string
          description: Symbol of the unit (e.g., $, %, kg)
      required:
        - name

    ObservationPoint:
      type: object
      description: A single timestamped value within a specific series
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the observation
        value:
          oneOf:
            - type: number
            - type: string
            - type: boolean
          description: Value of the observation
      required:
        - timestamp
        - value

    Series:
      type: object
      description: A logical group of observations sharing the same entity/metric/unit
      properties:
        id:
          type: string
          description: ID of the series
        name:
          type: string
          description: Human-readable name of the series
        entity:
          $ref: '#/components/schemas/Entity'
        metric:
          $ref: '#/components/schemas/Metric'
        unit:
          $ref: '#/components/schemas/Unit'
        frequency:
          type: string
          description: Frequency of the time series (e.g., monthly, annual)
          nullable: true
        description:
          type: string
          description: Description of the series
          nullable: true
        labels:
          type: object
          description: Additional labels and metadata at the series level
          additionalProperties: true
          nullable: true
        observations:
          type: array
          description: The ordered observations for this series
          items:
            $ref: '#/components/schemas/ObservationPoint'
      required:
        - entity
        - metric
        - observations

    QueryMeta:
      type: object
      description: Metadata about query execution and pagination
      properties:
        result_count:
          type: integer
          description: Number of results returned in this response
        page:
          $ref: '#/components/schemas/PageInfo'
        diagnostics:
          type: object
          description: Additional diagnostic information about the query execution
          additionalProperties: true
      required:
        - result_count

    PageInfo:
      type: object
      description: Pagination information for the response
      properties:
        limit:
          type: integer
          description: Number of items requested per page
        offset:
          type: integer
          description: Offset index of the first item in this page
        next_cursor:
          type: string
          description: Opaque token to fetch the next page
          nullable: true
        has_more:
          type: boolean
          description: Whether there are more items available beyond this page
      required:
        - limit
        - offset
        - has_more

    URLRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: URL to scrape
      required:
        - url

    ScrapeArtifacts:
      type: object
      description: URLs to stored artifacts
      properties:
        html_url:
          type: string
          description: URL to stored HTML
        markdown_url:
          type: string
          description: URL to stored markdown
        tables_base_url:
          type: string
          description: Base URL for stored tables

    ScrapeResponse:
      type: object
      description: Response from web scraping endpoint
      properties:
        series:
          type: array
          description: Array of observations extracted from the page (flat structure)
          items:
            $ref: '#/components/schemas/ObservationData'
        artifacts:
          $ref: '#/components/schemas/ScrapeArtifacts'
        cached:
          type: boolean
          description: Whether this result was retrieved from cache
        source_id:
          type: string
          description: Database source ID (present when cached=true)
          nullable: true
        metadata:
          type: object
          description: Additional metadata about the scrape
          properties:
            result_count:
              type: integer
              description: Number of observations extracted
          additionalProperties: true
        html:
          type: string
          description: Original HTML of the page (only if html=true query param)
          nullable: true
        markdown:
          type: string
          description: Markdown representation of the page (only if markdown=true query param)
          nullable: true
      required:
        - series
