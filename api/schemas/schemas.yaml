components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: integer
        details:
          type: string
          nullable: true
      required:
        - error
        - code

    UsageStats:
      type: object
      properties:
        queries_used:
          type: integer
          description: Number of queries used in current period
        queries_limit:
          type: integer
          description: Maximum queries allowed in current period
        period_start:
          type: string
          format: date-time
        period_end:
          type: string
          format: date-time
        concurrent_requests:
          type: integer
          description: Current number of concurrent requests
        max_concurrent:
          type: integer
          description: Maximum concurrent requests allowed
        tokens_in:
          type: integer
          description: Total input tokens consumed in current period
        tokens_out:
          type: integer
          description: Total output tokens consumed in current period
        errors:
          type: integer
          description: Total number of errors in current period
      required:
        - queries_used
        - queries_limit
        - period_start
        - period_end
        - concurrent_requests
        - max_concurrent
        - tokens_in
        - tokens_out
        - errors

    Observation:
      type: object
      properties:
        date:
          type: string
          format: date
        value:
          type: number
      required:
        - date
        - value

    Series:
      type: object
      properties:
        series_id:
          type: string
          description: short id for the series (optional but recommended)
        name:
          type: string
          description: human-friendly name for the series
        unit:
          type: string
          description: unit of measurement (optional)
        observations:
          type: array
          items:
            $ref: '#/components/schemas/Observation'
      required:
        - name
        - observations

    QueryResponse:
      type: object
      properties:
        series:
          type: array
          items:
            $ref: '#/components/schemas/Series'
        metadata:
          type: object
          description: Additional metadata about the query execution
          additionalProperties: true
      required:
        - series

    NLQueryResponse:
      allOf:
        - $ref: '#/components/schemas/QueryResponse'
        - type: object
          properties:
            sql_query:
              type: string
              nullable: true
              description: The generated SQL query
            description:
              type: string
              description: Natural language description of the query result
          required:
            - sql_query

    NLQueryRequest:
      type: object
      properties:
        query:
          type: string
      required:
        - query

    SQLQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: SQL query to execute (primary field name)
        sql_query:
          type: string
          description: SQL query to execute (alternative/legacy field name)
      oneOf:
        - required: [query]
        - required: [sql_query]

    URLRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
      required:
        - url

    DBSeries:
      type: object
      description: Database-structured series returned from cached scrape results
      properties:
        id:
          type: integer
        entity_id:
          type: integer
        metric_id:
          type: integer
        unit_id:
          type: integer
          nullable: true
        frequency:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        labels:
          type: object
          additionalProperties: true
          nullable: true
        observations_count:
          type: integer
      required:
        - id
        - entity_id
        - metric_id

    ScrapeResponse:
      type: object
      properties:
        html:
          type: string
          description: Original HTML of the page (if requested)
        markdown:
          type: string
          description: Markdown representation of the page (if requested)
        series:
          type: array
          description: Extracted time series from detected tables (fresh scrape) or structured DB series (cached)
          items:
            oneOf:
              - $ref: '#/components/schemas/Series'
              - $ref: '#/components/schemas/DBSeries'
        artifacts:
          type: object
          description: URLs or file paths to stored artifacts
          properties:
            html_url:
              type: string
            markdown_url:
              type: string
            tables_base_url:
              type: string
        cached:
          type: boolean
          description: Whether this result was retrieved from cache
        source_id:
          type: integer
          description: Database source ID (present when cached=true)
      required:
        - series
