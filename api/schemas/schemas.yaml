components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: integer
        message:
          type: string
          description: Additional error message
        details:
          type: string
          nullable: true
      required:
        - error
        - code

    EndpointUsageStats:
      type: object
      description: Usage statistics for a specific endpoint
      properties:
        calls_used:
          type: integer
          description: Number of calls used in current period
        calls_limit:
          type: string
          description: Maximum calls allowed in current period (returned as string)
        tokens_in:
          type: integer
          description: Total input tokens consumed in current period
        tokens_out:
          type: integer
          description: Total output tokens consumed in current period
        errors:
          type: integer
          description: Total number of errors in current period
        remaining:
          type: integer
          description: Number of calls remaining in current period
      required:
        - calls_used
        - calls_limit
        - tokens_in
        - tokens_out
        - errors
        - remaining

    UsageStats:
      type: object
      description: Usage statistics per endpoint
      properties:
        period_start:
          type: string
          format: date-time
          description: Start of the current usage period
        period_end:
          type: string
          format: date-time
          description: End of the current usage period
        plan:
          type: string
          description: Current subscription plan
        endpoints:
          type: object
          description: Usage statistics broken down by endpoint
          properties:
            nl:
              $ref: '#/components/schemas/EndpointUsageStats'
            sql:
              $ref: '#/components/schemas/EndpointUsageStats'
            scrape:
              $ref: '#/components/schemas/EndpointUsageStats'
          required:
            - nl
            - sql
            - scrape
      required:
        - period_start
        - period_end
        - plan
        - endpoints

    ObservationData:
      type: object
      description: A single observation with full metadata (flat structure)
      properties:
        ts:
          type: string
          format: date-time
          description: Timestamp of the observation
        value:
          type: string
          description: Value of the observation (returned as string)
        entity_name:
          type: string
          description: Human-readable name of the entity
        entity_id:
          type: string
          description: ID of the entity
          nullable: true
        metric_name:
          type: string
          description: Human-readable name of the metric
        metric_id:
          type: string
          description: ID of the metric
          nullable: true
        unit_name:
          type: string
          description: Human-readable name of the unit
        unit_id:
          type: string
          description: ID of the unit
          nullable: true
        frequency:
          type: string
          description: Frequency of the time series (e.g., monthly, annual)
          nullable: true
        series_description:
          type: string
          description: Description of the series
          nullable: true
        labels:
          type: object
          description: Additional labels and metadata
          additionalProperties: true
          nullable: true
        source:
          type: string
          description: Source URL for the data
          nullable: true
        series_id:
          type: string
          description: ID of the series
          nullable: true
      required:
        - ts
        - value

    QueryMetadata:
      type: object
      description: Metadata about query execution
      properties:
        result_count:
          type: integer
          description: Number of results returned
      additionalProperties: true

    QueryResponse:
      type: object
      description: Response from SQL query endpoint
      properties:
        series:
          type: array
          description: Array of observations (flat structure, not nested)
          items:
            $ref: '#/components/schemas/ObservationData'
        sql_query:
          type: string
          description: The SQL query that was executed
          nullable: true
        metadata:
          $ref: '#/components/schemas/QueryMetadata'
      required:
        - series

    NLQueryResponse:
      type: object
      description: Response from natural language query endpoint
      properties:
        sql_query:
          type: string
          description: The generated SQL query
        series:
          type: array
          description: Array of observations (flat structure, not nested)
          items:
            $ref: '#/components/schemas/ObservationData'
        metadata:
          type: object
          description: Extended metadata including query resolution details
          additionalProperties: true
        description:
          type: string
          description: Natural language description of the query result
      required:
        - sql_query
        - series
        - description

    NLQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: Natural language query
      required:
        - query

    SQLQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: SQL query to execute (primary field name)
        sql_query:
          type: string
          description: SQL query to execute (alternative/legacy field name)
      oneOf:
        - required: [query]
        - required: [sql_query]

    URLRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: URL to scrape
      required:
        - url

    ScrapeArtifacts:
      type: object
      description: URLs to stored artifacts
      properties:
        html_url:
          type: string
          description: URL to stored HTML
        markdown_url:
          type: string
          description: URL to stored markdown
        tables_base_url:
          type: string
          description: Base URL for stored tables

    ScrapeResponse:
      type: object
      description: Response from web scraping endpoint
      properties:
        series:
          type: array
          description: Array of observations extracted from the page (flat structure)
          items:
            $ref: '#/components/schemas/ObservationData'
        artifacts:
          $ref: '#/components/schemas/ScrapeArtifacts'
        cached:
          type: boolean
          description: Whether this result was retrieved from cache
        source_id:
          type: string
          description: Database source ID (present when cached=true)
          nullable: true
        metadata:
          type: object
          description: Additional metadata about the scrape
          properties:
            result_count:
              type: integer
              description: Number of observations extracted
          additionalProperties: true
        html:
          type: string
          description: Original HTML of the page (only if html=true query param)
          nullable: true
        markdown:
          type: string
          description: Markdown representation of the page (only if markdown=true query param)
          nullable: true
      required:
        - series
